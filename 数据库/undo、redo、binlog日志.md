# undo、redo、binlog日志

#### 1. 什么是redo log日志？ (2_2024_02_29)
redo log日志是用来保证InnoDb存储引擎事物的持久性的，其主要作用用于数据库的崩溃恢复。redo log日志是存储引擎生成的日志，记录的是物理页级别的日志，比如页号XX，偏移量XX，写入'ZZ'数据。




#### 2. 为什么需要redo log日志？(2_2024_04_14)
为弥补CPU与磁盘运行速度的鸿沟，引入了缓存机制，对数据页的访问，都是先加载到内存之后再访问。对数据页的修改，如果不及时从内存更新到磁盘，就存在数据丢失的风险，如果每次都
立即更新，效率太低。

那有没有一种方法，可以使得，能在故障的时候不会出现数据丢失，效率又非常高，WAL(write ahead log机制)。每次提交事物之前，都保证对内存页相关的修改日志落到磁盘上。

如果出现故障了，就根据日志来做恢复，这就是REDO LOG日志。



#### 3. 可不可以不写日志，直接写磁盘呢？ (2_2024_02_29)
当然可以，每次修改数据页都进行一次落盘操作，不过对数据页的修改是随机的，落盘操作也将是随机磁盘IO效率较低，而先写日志，再由后台线程将数据页落盘这样效率会更高，
因为日志的落盘是磁盘顺序写。

#### 4. redo log日志的整体流程是怎么样的？ (2_2024_02_29)
1. 读磁盘数据复制到内存当中，修改内存中的数据页
2. 生成redoo log 日志，记录到redo log buffer当中
3. commit 之前将redo log日志刷新到磁盘上
4. 选择恰当的时间，将脏数据页刷新到磁盘上

#### 5. 什么是Force-log-at-commit机制？  (2_2024_02_29)
Force-log-at-commit要求，再事务提交之前，其所产生的日志要先持久化到磁盘。

write是异步非阻塞的，数据只会被写到操作系统的缓存当中， 并不会立即刷新到磁盘，必须在commit之前调用一个fsycn函数，这个函数同步阻塞的，必须等数据落盘之后才返回
，确保事物的持久性。

#### 6. 那怎么恢复数据？ (2_2024_02_29)
redo log日志记录的是对数据页的修改操作，直接再执行一次redo log日志即可

#### 7. undo log于redo log日志是叛过程吗？ (2_2024_02_29)
redo log日志和undo log日志不是逆过程，redo log日志用户数据库崩溃恢复，而undo log用于支持事物会滚和mvcc的。并且两者记录的内容完全不一样，redo log日志记录的是对数
数据页的修改，而undo log日志记录的是记录的历史版本。

#### 8. 什么是binlog日志？  (2_2024_02_29)
binlog日志的使用场景通常是主从同步，数据备份。在执行数据的增、删、改操作的时候就会生成binlog日志，里面记录了操作类型，以及操作结果。


#### 9. 什么是插入缓冲？  (2_2024_04_14)
辅助索引无序插入开销大，比如读磁盘，B+树分裂。优化方案，引入插入缓存，对辅助索引的修改不立即就修改索引，而是先放到插入缓存里面去，后续对插入缓存内容排序，以一定频率与
辅助索引合并。

优化内容: 无序变为有序

#### 10. 什么是double write？ (2_2024_04_14)
redo log记录的是对物理页的修改，比如页号xx，偏移量xx，数据为'zz'，如果对数据页进行重做的期间，又重启了，这个时候redo log日志，记录的对物理页的修改就不正确了，无法在进行第二次恢复。

如何解决这个问题: 两次写，先把数据页写入到一个独立的空间，然后再对原数据页进行重做，这样当数据页失效的时候，可以在引入备份来进行修改。

#### 11. 什么是自适应hash ？  (2_2024_04_14)
Innodb 存储引擎基于对查询的分析，发现某查询更加适合hash索引，就会自主为其建立一个hash索引，优化查询效率，无需人为介入。

#### 12. 异步IO？  (2_2024_04_14)
某条查询语句，需要扫描多个磁盘页，Innodb底层实现，不是one by one的去夹在，一个使用AIO去同时加载多个磁盘页，提升查询效率

#### 13. 刷新邻接页？  (2_2024_04_14)
将同区相邻的脏页一同写入，使用AIO同步刷新，提升效率







参考资料:
1. https://www.xiaolincoding.com/mysql/log/how_update.html#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-redo-log
