# undo、redo、binlog日志

#### 1. 什么是redo log日志？ (2_2024_12_09)
redo log日志即重做日志，用户数据库的崩溃恢复，保证事物的持久性。其日志内容记录的是xx页号，偏移量yy，写入zz。


#### 2. 为什么需要redo log日志？(3_2024_12_09)
存储引擎对数据页的修改是在内存中进行的，如果修改不及时写入到磁盘中进行持久化，就可能出现丢失的风险，那如果每次修改都立即写入到磁盘中进行持久化，又存在效率较低的问题。

为解决上述问题，建设了一套WAL(WRITE AHEAD LOG)机制，在事物提交之前，先把相关日志持久化到磁盘。因为日志持久化到磁盘是APPEND ONLY 顺序写机制，效率要比每次把数据页写入到磁盘

的效率更高。

如果机器突然宕机，内存中数据页丢失，就可以根据redo log日志来恢复数据。


#### 3. 可不可以不写日志，直接写磁盘呢？ (3_2024_12_09)
当然可以。每次对数据页的修改都直接落盘是随机写，效率较低，而使用WAL机制，日志落盘是顺序写，效率较高。


#### 4. redo log日志的整体流程是怎么样的？ (3_2024_12_09)
1. 读磁盘数据复制到内存当中，修改内存中的数据页
2. 生成redoo log 日志，记录到redo log buffer当中
3. commit 之前将redo log日志刷新到磁盘上
4. 操作系统选择恰当的时间，将脏数据页刷新到磁盘上

#### 5. 什么是Force-log-at-commit机制？  (3_2024_12_09)
Force-log-at-commit要求，再事务提交之前，其所产生的日志要先持久化到磁盘。

write操作的数据只会被写到操作系统的缓存当中， 并不会立即刷新到磁盘，必须在commit之前调用一个fsycn函数，这个函数同步阻塞的，必须等数据落盘之后才返回
，确保事物的持久性。

#### 6. 那怎么恢复数据？ (3_2024_12_09)
redo log日志记录的是对数据页的修改操作，直接再执行一次redo log日志即可

#### 7. undo log于redo log日志是叛过程吗？ (3_2024_02_29)
redo log日志和undo log日志不是逆过程。

redo log日志： 用来解决每次修改数据页都写入磁盘持久化效率地的问题。当数据库程序崩溃的时候可用来做故障恢复

undo log日志： 用来做MVVC多版本并发控制 & 事物回滚，用来保证事物的原子性


#### 8. 什么是binlog日志？  (3_2024_02_29)
当发生写操作时，会产生一条binlog日志，常用于主从同步，数据备份。

#### 9. binlog日志有几种格式？  (3_2024_02_29)
1. statement，记录原始的SQL语句，缺点在于在使用limit 1时，走不同索引可能获取不同值，从而导致主从结果有差异
2. row，记录影响行原始数据和新数据，便于做操作，我们就是基于row模式做的


#### 9. 什么是插入缓冲？  (3_2024_12_09)
对主键索引插入数据通常是有序的，但是辅助索引插入通常是无序的，无序对磁盘是随机读性能较低，为优化上述问题，引入了插入缓冲，对辅助索引的修改不立即就修改，而是先放到插入缓冲区里面去，后续对

修改内容进行排序，然后再一起修改，变无序为有序，提升性能。

#### 10. 什么是double write？ (3_2024_12_09)
redo log记录的是对页的修改，比如页号xx，偏移量xx，数据为'zz'，如果对数据页进行重做的期间，又重启了，这个时候redo log日志，记录的对物理页的修改就不正确了，无法在进行第二次恢复。

如何解决这个问题: 两次写，先把数据页写入到一个独立的空间，然后再对原数据页进行重做，这样当数据页失效的时候，可以在引入备份来进行修改。

#### 11. 什么是自适应hash ？  (3_2024_12_09)
Innodb 存储引擎基于对查询的分析，发现某查询更加适合hash索引，就会自主为其建立一个hash索引，优化查询效率，无需人为介入。

#### 12. 异步IO？  (3_2024_12_09)
某条查询语句，需要扫描多个磁盘页，Innodb底层实现，不是one by one的去夹在，一个使用AIO去同时加载多个磁盘页，提升查询效率







参考资料:
1. https://www.xiaolincoding.com/mysql/log/how_update.html#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-redo-log
2. [MySQL binlog的3种格式对比](https://blog.csdn.net/wang0907/article/details/126120638)
