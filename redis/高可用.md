### redis 部署模型

#### 1. redis 有几种部署模型？(3_2023_11_14)
1. 单机模式
2. 主从复制
3. 哨兵
4. 集群

#### 2. 单机模式的优缺点，适用场景？(3_2023_11_14)
优点：
1. 部署简单，成本低
2. 不存在数据不一致问题
缺点：
1. 存在单点故障，机器如果坏了，数据也会丢失
使用场景：
1. 对可用性要求不高的场景


#### 3. 主从复制的优缺点，适用场景？(3_2023_11_13)
优点：
1. 解决了机器故障数据会丢失的问题，业务方手动更改节点，可恢复使用
2. 是哨兵模式以及集群模式的基础
3. 可读写分离

缺点：
1. 需要手动介入，无法自动恢复
2. 存在主从复制延迟

适用模式：
1. 适用于对可用性无太大要求的场景

#### 4. 哨兵模式的优缺点，适用场景？(3_2023_11_14)
优点：
1. 主节点故障，无需手动恢复

缺点：
1. 成本较大
2. 存在主从复制延迟

使用场景：
1. 对可用性有一定要求，对扩容无太大要求，单机可满足性能以及容量要求

#### 5. 集群模式的优缺点，适用场景？(3_2023_11_14)
优点：
1. 具备哨兵模式的所有优点、同时可支持扩容
2. 不需要部署单独的哨兵实例
缺点：
1. 存在主从复制延迟

使用场景:
1. 使用高可用、可扩容的使用场景

#### 6. redis为什么需要持久化？(3_2023_11_14)
为避免redis实例重启，导致内存数据丢失

#### 7. redis支持几种持久化？(3_2023_11_14)
AOF(Append Only File) 和 RDB (Redis Database)

#### 8. 什么是RDB？ (3_2023_11_14)
RDB即内存快照，执行RDB相当于把内存中的数据快照存储一份到磁盘上

save 900 1  当时间到900秒时，如果至少有1个key发生变化，就会自动触发bgsave命令创建快照

save 300 10  当时间到300秒时，如果至少有10个key发生变化，就会自动触发bgsave命令创建快照

save 60 10000    当时间到60秒时，如果至少有10000个key发生变化，就会自动触发bgsave命令创建


#### 9. 执行RDB的时机有哪些？(3_2023_11_14)
主动触发: save 或者 bgsave命令，save会阻塞进程而bgsave不会
配置文件: save <seconds> <changes>，seconds时间内，至少changes个key被改变，则执行bgsave
主从复制: 从库全量复制同步主库数据，主库会执行bgsave
flushall: 清空服务器数据
关闭服务器: 关闭服务器之前执行一次RDB

#### 10. 什么是AOF？(3_2023_11_14)
AOF (append only file)，在redis执行完写命令之后，按照一定的策略把命令刷新到磁盘上，避免数据丢失。redis写日志是在操作之后写的，正常都是操作之前写


#### 11. AOF刷新磁盘的策略？ (3_2023_11_14)
三种策略：

appendfsync always: 每次都刷新到磁盘，性能最差，不丢失数据

appendfsync everysec: 每s刷新一次，默认配置，性能一般，服务器宕机可能丢失数据

appendfsync no: 不主动同步磁盘，由操作系统决定何时同步，性能最好，服务器宕机可能丢失数据


#### 12. AOF什么时候会重写？(3_2023_11_14)
当AOF文件大于指定大小的时候，就会执行重写，读取内存中的所有键值对，然后用一条命令记录到AOF文件中，然后用新文件替换旧文件，完成重写。

#### 13. AOF重写期间进行的操作怎么办？(3_2023_11_14)
有一个AOF重写缓冲区，重写期间数据都写入到重写缓冲区中，当重写完成之后，缓冲区数据再写入到文件当中。

#### 14. 有RDB和AOF持久化，数据会丢失吗？ (3_2023_11_14)
只要服务器不发生故障，AOF就不会丢失数据


#### 15. redis集群将数据划分为多少个槽？(3_2023_11_14)
16384个槽，如果有多个节点，则每个节点负责一部分槽，分配可以不均匀，性能好的机器，多分配一些


#### 16. 如何判断数据属于哪个槽？(3_2023_11_14)
crc16 + 对16384取模得到属于哪个槽


#### 17. 主从复制的大概逻辑？(3_2023_11_14)
总共分为3个阶段:
第一阶段: 协商同步阶段
1. 从服务器向主服务器发送psync ? -1
2. 主服务器收到命令后，向从服务器发送fullresync runId offset
第二阶段: 主服务器同步数据给从服务器
1. 主服务器执行bgsave，将rdb文件发送给从服务
2. 从服务器丢弃原来的数据，加载rdb文件，执行完成后回复主服务器
第三阶段: 主服务器同步新写入的数据给从服务器
1. 主服务器将最新的写命令传播给从服务器

增量复制阶段:
1. 主服务器和从服务器建立长连接，主服务器向从服务器同步新增写命令

#### 18. 如果有从服务器和主服务器断开连接了，然后又重新链上了会怎么样？(3_2023_11_16)
如果从服务器当前已有数据的下标，还在主服务器的环形队列当中，则把新增数据发送给从服务器，如果不在了，则进行全量同步


#### 19. 什么是repl backlog buffer？(3_2023_11_16)
如果一个redis节点是主服务器，那么它会创建一个环形队列，记录写命令，用户异步同步给从服务器。

#### 20. 什么是replication buffer？(3_2023_11_16)
在全量同步阶段，记录主服务器执行bgsave阶段写入的新命令，后续同步给从服务器。

#### 21. 为什么会出现主从不一致？(3_2023_11_16)
因为主从复制是异步的

#### 22. 如何应对主从复制不一致的情况？(3_2023_11_16)
1. 保证主从服务器良好的网络状态
2. 监控主从偏移量的差异，根据差异做策略

#### 23. 主从什么情况下会出现数据丢失？(2_2023_11_15)
1. 主服务器宕机，主服务器还没来得及同步数据给从服务器
2. 脑裂，业务继续向老主节点写数据，而集群已经选举出一个新主节点了

#### 24. 如何避免集群数据丢失呢？(2_2023_11_15)
1. 针对主从复制延迟: min-slaves-max-lag，如果主从主从延迟同步时间一旦超过了这个值，就不在允许写数据了
2. 针对脑裂：min-slaves-to-write，一个主节点至少拥有这么多从节点，才允许写





参考资料:
1. [ ] [Redis持久化机制：RDB和AOF](https://juejin.cn/post/6844903939339452430)
2. [ ] [AOF 持久化是怎么实现的](https://www.xiaolincoding.com/redis/storage/aof.html#%E6%80%BB%E7%BB%93)
3. [ ] [深入分析cluster集群模式](https://www.cnblogs.com/wzh2010/p/15886799.html)
4. [ ] [主从复制是怎么实现的](https://www.xiaolincoding.com/redis/cluster/master_slave_replication.html#%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%90%8C%E6%AD%A5)
